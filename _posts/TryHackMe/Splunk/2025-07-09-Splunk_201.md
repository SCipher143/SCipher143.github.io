---
layout: post
title: "Incident Handling with Splunk"
date: 2025-07-07 15:30:00 -0700
categories: [TryHackMe, Blue Team, SIEM]
tags: [THM, Splunk, SIEM, Incident Handling, Detection, Blue Team]
description: Learn to use Splunk for incident handling through interactive scenarios. Practice detecting and responding to real-world threats using Splunk‚Äôs search and analysis capabilities.
---

## Incident Handling Scenario

In this exercise, we will investigate a cyber attack in which the attacker defaced an organization's website. This organization has Splunk as a SIEM solution setup. Our task as a Security Analysis would be to investigate this cyber attack and map the attacker's activities into all 7 of the Cyber Kill Chain Phases. It is important to note that we don't need to follow the sequence of the cyber kill chain during the Investigation. One finding in one phase will lead to another finding that may have mapped into some other phase.

### Cyber Kill Chain 

We will follow the Cyber kill Chain Model and map the attacker's activity in each phase during this Investigation. When required, we will also utilize Open Source Intelligence (OSINT) and other findings to fill the gaps in the kill chain. It is not necessary to follow this sequence of the phases while investigating.

- Reconnaissance
- Weaponization
- Delivery
- Exploitation
- Installation
- Command & Control
- Actions on Objectives
  
### Scenario   

 A Big corporate organization Wayne Enterprises  has recently faced a cyber-attack where the attackers broke into their network, found their way to their web server, and have successfully defaced their website `http://www.imreallynotbatman.com`. Their website is now showing the trademark of the attackers with the message YOUR SITE HAS BEEN DEFACED  as shown below.  

![Desktop View](/assets/img/Splunk_IH/1.png){: width="700" height="400" }

They have requested " US " to join them as a Security Analyst and help them investigate this cyber attack and find the root cause and all the attackers' activities within their network.

The good thing is, that they have Splunk already in place, so we have got all the event logs related to the attacker's activities captured. We need to explore the records and find how the attack got into their network and what actions they performed.

This Investigation comes under the  Detection and Analysis phase.

#### Splunk

During our investigation, we will be using Splunk as our SIEM solution. Logs are being ingested from webserver/firewall/Suricata/Sysmon etc. In the data summary tab, we can explore the log sources showing visibility into both network-centric and host-centric activities.To get the complete picture of the hosts and log sources being monitored in Wayne Enterprise, please click on the Data summary and navigate the available tabs to get the information.

![Desktop View](/assets/img/Splunk_IH/2.png){: width="700" height="400" }

### Interesting log Sources

Some of the interesting log sources that will help us in our Investigation are:

| Log Source       | Details                                                                                    |
| ---------------- | ------------------------------------------------------------------------------------------ |
| `wineventlog`    | Contains Windows Event logs                                                                |
| `winRegistry`    | Logs related to registry creation, modification, or deletion                               |
| `XmlWinEventLog` | Sysmon event logs ‚Äì important from an investigation perspective                            |
| `fortigate_utm`  | Fortinet Firewall logs                                                                     |
| `iis`            | IIS web server logs                                                                        |
| `Nessus:scan`    | Results from the Nessus vulnerability scanner                                              |
| `Suricata`       | Alerts from Suricata IDS, showing what was triggered and why ‚Äì critical for investigations |
| `stream:http`    | Network flow logs related to HTTP traffic                                                  |
| `stream:DNS`     | Network flow logs related to DNS traffic                                                   |
| `stream:icmp`    | Network flow logs related to ICMP traffic                                                  |

 Note:  All the event logs that we are going to investigate are present in  `index=botsv1`  

Now that we know what hosts we have to investigate, what sources and the source types are, let's connect to the lab and start Investigating .

Room Machine

Before moving forward, deploy the machine. When you deploy the machine, it will be assigned an IP Machine IP : MACHINE_IP . The machine will take up to 3-5 minutes to start.

Disclaimer

As this is a public [dataset](https://github.com/splunk/botsv1) released by Splunk, which depicts a realistic scenario, it is advised that this dataset may contain profanity, slang, vulgar expressions, and/or generally offensive terminology. Please use with discretion.

---

## Reconnaissance Phase

Reconnaissance is an attempt to discover and collect information about a target. It could be knowledge about the system in use, the web application, employees or location, etc.


We will start our analysis by examining any reconnaissance attempt against the webserver imreallynotbatman.com. From an analyst perspective, where do we first need to look? If we look at the available log sources, we will find some log sources covering the network traffic, which means all the inbound communication towards our web server will be logged into the log source that contains the web traffic. Let's start by searching for the domain in the search head and see which log source includes the traces of our domain.

**Search Query**: `index=botsv1 imreallynotbatman.com`

**Search Query explanation**: We are going to look for the event logs in the index "botsv1" which contains the term `imreallynotbatman.com` 

![Desktop View](/assets/img/Splunk_IH/3.png){: width="700" height="400" }

![Desktop View](/assets/img/Splunk_IH/4.png){: width="700" height="400" }

Here we have searched for the term `imreallynotbatman.com` in the index `botsv1`.  
In the `sourcetype` field, we observed that the following log sources contain traces of this search term:

- `Suricata`
- `stream:http`
- `fortigate_utm`
- `iis`

From the names of these log sources, it's clear what each may contain. Every analyst may take a different approach to investigating a scenario.  
Our first task is to identify the **IP address attempting reconnaissance activity** on our web server.  

A logical starting point is to examine **web traffic coming into the network**.  
So, we begin by investigating the log source `stream:http`, which contains HTTP traffic logs.

Look specifically at the `src_ip` field in the left panel ‚Äî this field contains the **source IP address** found in the logs.

---

#### üîç Search Query

```spl
index=botsv1 imreallynotbatman.com sourcetype=stream:http
```

**Search Query Explanation**: This query will only look for the term  `imreallynotbatman.comin` the stream:http log source.

![Desktop View](/assets/img/Splunk_IH/5.png){: width="700" height="400" }

> **Note:** If you don't find the field of interest, **keep scrolling** in the left panel. When you click on a field, it will display all the values it finds in the logs.

---

So far, we have found two IPs in the `src_ip` field:

- `40.80.148.42`  
- `23.22.63.114`

The first IP (`40.80.148.42`) appears to be responsible for a **higher percentage of the logs**, which suggests it could be the suspicious actor.

To confirm:

1. Click on each IP one by one ‚Äî it will be added to the search query.
2. Review the logs for each IP.
3. Determine which one is performing reconnaissance.

---

### üîç Deep Dive into 40.80.148.42

To further confirm suspicion about `40.80.148.42`:

- Click on the IP to filter logs.
- Examine important fields like:
  - **User-Agent**
  - **POST requests**
  - **URIs**

These fields can reveal the nature of the traffic coming from that IP and help confirm whether it's part of a reconnaissance attempt.

![Desktop View](/assets/img/Splunk_IH/6.png){: width="700" height="400" }

![Desktop View](/assets/img/Splunk_IH/7.png){: width="700" height="400" }

![Desktop View](/assets/img/Splunk_IH/8.png){: width="700" height="400" }

![Desktop View](/assets/img/Splunk_IH/9.png){: width="700" height="400" }
