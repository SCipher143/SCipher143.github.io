---
layout: post
title: "KQL 101, A Scandal in Valdoria ‚Äì KC7 Cyber Challenge"
date: 2025-07-18 10:00:00 -0700
categories: [SOC, Blue Team, Threat Hunting]
tags: [KC7, KQL, Microsoft Sentinel, Detection, Blue Team]
description: Build your KQL skills in the KC7 Cyber Challenge by working through real-world threat hunting scenarios. Master the basics of querying with KQL and learn how to pivot through logs to uncover suspicious activity.
---

## üîç Overview

The **KQL 101** section is the first part of the [KC7 Cyber Challenge Module 132](https://kc7cyber.com/challenges/132), introducing foundational concepts for querying logs with **Kusto Query Language (KQL)**. This module sets the stage for the rest of the challenge, walking you through how to investigate events using real-world log formats.

### üìö Module Structure

This challenge is divided into four parts:
1. **KQL 101** 
2. Welcome to Valdoria!
3. Plenty of Phish
4. A Scandal

Each section builds on the last. For example, you may uncover an IP address or user account in one task that becomes the key to solving several others.

### üõ†Ô∏è Skills Practiced

- Writing basic and advanced **KQL queries**
- Using tables like `SigninLogs`, `DeviceLogonEvents`, etc.
- Filtering and projecting fields
- Pivoting on IoCs (IP addresses, usernames, hostnames)
- Log correlation and event tracing

### üß™ What You'll Learn

By the end of this section, you'll be able to:
- Query effectively in Microsoft Sentinel
- Identify suspicious logon behavior
- Track user and device activity through logs
- Use summarization and visualization techniques for analysis

### ‚úÖ Completion Notes

The **KQL 101** section is a great primer for new threat hunters or SOC analysts looking to sharpen their detection and log analysis skills in a Microsoft ecosystem. Everything learned here plays a role in uncovering deeper threats in the upcoming sections of the challenge.

---

## Intro: Welcome to Valdoria!

On the eve of the election, Nene Leaks, the esteemed editor of The Valdorian Times, awoke to a nightmare. The Valdorian Times, the beacon of truth for the city, published a scandalous article accusing Luffy of corruption and misconduct. The article, a vile concoction of lies, was not what she had approved.

The article alleged that Luffy, hailed for his environmental activism and social reforms, was secretly involved in a land deal scandal, exploiting his position to benefit a shadowy network of real estate moguls. Furthermore, it accused Luffy of accepting substantial bribes to push environmentally damaging policies, a stark contradiction to his public persona.

However, the article, a vile concoction of lies, was not what had been approved by the newspaper's editor üòµ.

The Valdorian Times has hired you as a cyber incident responder to help investigate the incident and get to the bottom of how the falsified article was published.

---

### Run a take 10 on each of the tables to see what kind of data they contain.

![Desktop View](/assets/img/KQL101/1.png){: width="700" height="400" }


Now that we have access to the data, we'll need to get a lay of the land. Let's get some more information about the Valdorian Times.

---

### How many employees work at the Valdorian Times?

![Desktop View](/assets/img/KQL101/2.png){: width="700" height="400" }

---

We can use the where operator with the Employees table to find a specific employee.

Here is a template you can follow:

```KQL
Table
| where <field> <operator> <value>
```

---

### What is the Editorial Director's name?

![Desktop View](/assets/img/KQL101/3.png){: width="700" height="400" }

> **Note**  
> Email = **nene_leaks@valdoriantimes.news**
> Name = **Nene Leaks**
{: .note }

---

We can learn more about Nene Leaks using information from other tables. Let's take her email address from the Employees table and use it in a query for the Email table.

### How many emails did Nene Leaks receive?

![Desktop View](/assets/img/KQL101/4.png){: width="700" height="400" }

---

You can use the distinct operator to find unique values in a specific column.

### How many distinct senders were seen in the email logs from the domain name "weprinturstuff.com"?

![Desktop View](/assets/img/KQL101/5.png){: width="700" height="400" }

---

### How many distinct websites did ‚ÄúLois Lane‚Äù visit?

![Desktop View](/assets/img/KQL101/6.png){: width="700" height="400" }

![Desktop View](/assets/img/KQL101/7.png){: width="700" height="400" }

---

### How many distinct domains in the PassiveDns records contain the word ‚Äúhire‚Äù?

---

![Desktop View](/assets/img/KQL101/8.png){: width="700" height="400" }

---

Review the emails sent to Clark Kent for the one sent on January 31, 2024 containing the final edits for the election OpEd.

> **Note**
> Email = **clark_kent@valdoriantimes.news**


### What was the subject line of this email?

![Desktop View](/assets/img/KQL101/9.png){: width="700" height="400" }

---

Who sent this email containing the final edits for the OpEd piece?

### Enter the sender's email address.

`ronnie_mclovin@valdoriantimes.news`

### What was the name of the .docx file that was sent in this email?

`OpEdFinal_to_print.docx`

---

So, it looks like Ronnie did send the email. When you go back and talk to Ronnie, she is adamant that she never sent the draft. She thinks maybe someone else used her account to send it.

She doesn't recall getting any unusual emails or any other weird activity on her computer.

### Do you think this needs further investigation (yes/no)? Choose wisely üòâ

`yes`

---

You stop by The Valdorian Times office and meet with some staff. After the meeting, one employee, Sonia Gose, comes up to you and says she may have something that can help with your investigation.

### What is Sonia's job role?

![Desktop View](/assets/img/KQL101/10.png){: width="700" height="400" }

---

Sonia shows you a suspicious email she received a few weeks ago.

### What email address was used to send this email?

`newspaper_jobs@gmail.com`

---

### When was the email sent to Sonia Gose? Enter the exact timestamp from the logs.

![Desktop View](/assets/img/KQL101/11.png){: width="700" height="400" }

---

### Which URL was included in the email?

`https://promotionrecruit.com/published/Valdorian_Times_Editorial_Offer_Letter.docx`

---

You ask Sonia if she clicked on the link but she says she doesn't remember. Let's help her remember. üòê

### What is Sonia Gose's IP address?

`10.10.0.3`

---

Did Sonia click on this link?

### If so, enter the timestamp when she clicked the link. If not, type "no".

![Desktop View](/assets/img/KQL101/12.png){: width="700" height="400" }

`1/5/2024, 10:23:17 AM`

---
Oh no! It looks like Sonia did click on the link! üò±

### What was the name of the docx file in the link that Sonia clicked?

`Valdorian_Times_Editorial_Offer_Letter.docx`

---

If she clicked on the link, we should assume that file might have been downloaded. Let's see if we can find the file on her machine.

### What is Sonia Gose's hostname?

`UL0M-MACHINE`

---

### When did the downloaded docx file first show up on Sonia's machine?

![Desktop View](/assets/img/KQL101/13.png){: width="700" height="400" }

1/5/2024, 10:24:04 AM

---

### What was the full path of the docx file that was downloaded to Sonia's machine?

`C:\Users\sogose\Downloads\Valdorian_Times_Editorial_Offer_Letter.docx`

---

A hash is a string that uniquely represents the contents of a file. We can get the hash of a file by running it through a hashing algorithm. Lucky for us, the hashes of all downloaded files are already captured.

### What is the sha256 hash of the file that Sonia downloaded?

`60b854332e393a6a2f0015383969c3ac705126a6b7829b762057a3994967a61f`

---
After the malicious file was downloaded, it began executing malicious content ü™≤

Let's continue to look at Sonia's machine.

### What is the name of the file (.ps1) that was written to disk immediately after the docx was downloaded?

`hacktivist_manifesto.ps1`

![Desktop View](/assets/img/KQL101/14.png){: width="700" height="400" }

---

### When was this new file created?

`1/5/2024, 10:24:32 AM`

---

The file extension of this new file, ".ps1" is pretty interesting.

### Let's do some research! What type of file is this?

`PowerShell`

---

You manage to do some forensics and get a copy of the PowerShell script. Here's what it looks like:

![Desktop View](/assets/img/KQL101/15.png){: width="700" height="400" }

### What does the attacker say to "let you know they are here"?

`lol ur bout 2 get pwnd`

---

### According to the PowerShell script, what might be the hacker's favorite color?

`Green`

---

### The purpose of the script is to invoke ____ and uncover da truth

`Plink`

---

We might be able to find more information about the PowerShell script in ProcessEvents data.

Look for process events related to the PowerShell script. Use the name of the .ps1 file (hacktivist_manifesto.ps1) to find related ProcessEvents.

### How many Process Events are there related to this PowerShell script on Sonia's machine?

![Desktop View](/assets/img/KQL101/16.png){: width="700" height="400" }

---

It looks like one of the processes is using schtasks.exe, which creates scheduled tasks. Scheduled tasks can be used to conduct certain actions at a regular interval.

### What is the full command used to create the scheduled task?